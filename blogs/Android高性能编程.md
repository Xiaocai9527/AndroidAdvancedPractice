# Android高性能编程

## 界面优化

### 什么是卡顿

Android 每隔16ms 就会绘制一次 Activity 界面，如果由于一些原因导致了我们的逻辑 CPU 耗时大于 16ms ，UI就无法完成一次绘制，那么就会造成卡顿。简单来说就是 UI 线程被阻塞了。

### 卡顿发生的原因

#### 外部原因

* 频繁内存抖动，解决方法是避免频繁gc
* 方法耗时，解决方案是耗时函数放入子线程中

#### View内部原因

* view层级嵌套过深，使用 merge 或者 ViewStub 
* 设备开发者选项中有一个 GPU 过度绘制，尽量减少不必要或者重复的背景颜色



## 网络优化

主流采用的 okhttp 框架采用 http 2其实已经做了如下优化：

* 多路复用
* 头部压缩
* 异步并发请求



还可做如下优化：

* 去 DNS 的 ip 直连，节省域名解析时间
* 合并请求
* post 请求体过大时采取 gzip 压缩
* 对于不更新数据，进行本地缓存



## 内存优化

### 常见内存泄漏问题

* static 修饰符慎用
* 内部类对外部类持有引用
* 流，广播，cursor等没有反注册
* context 使用不当，造成 activity 的泄漏

* 不用的对象及时置空

### 内存溢出 OOM 原因

Android 系统为每一个应用程序都设置了一个硬性的 Dalvik Heap Size 最大限制阈值，这个阈值在不同的设备上会因为 RAM 大小不同而各有差异。如果你的应用程序接近这个阈值，此时再尝试分配内存时，很容易引起oom。

### 如何避免 OOM

#### 1) 使用更加轻量的数据结构

#### 2) 避免在Android里面使用Enum 枚举类

#### 3) 减少bitmap 对象的内存占用

* inSampleSize，缩放比例
* decode format ，解码格式

#### 4) 使用更小的资源图片

#### 5) 使用对象池，比如 LruCache 缓存类

#### 6) 使用stringbuilder 代替大量的 string 拼接



## 电量优化

在需要定位 app 中，对定位相隔时间，视需求定。

在 IM 即时通讯应用中，对 TCP 长连接心跳包的发送间隔时间，视具体情况而定。

